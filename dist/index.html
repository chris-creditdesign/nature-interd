<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
}

.outerwrapper {
  width: 100%;
  min-height: 900px;
  position: relative;
  border: 1px solid #c8c7cf;
}
.outerwrapper h2, .outerwrapper h3, .outerwrapper p {
  padding: 10px 10px 0 10px;
  margin: 0;
}
.outerwrapper .widget-scale, .outerwrapper .widget-slider {
  position: absolute;
  top: 0;
}
.outerwrapper .widget-scale {
  pointer-events: none;
}
.outerwrapper input[type=range] {
  -webkit-appearance: none;
}
.outerwrapper input[type=range]:focus {
  outline: none;
}
.outerwrapper input[type=range]::-moz-focus-outer {
  border: 0;
}
.outerwrapper input[type=range]::-webkit-slider-runnable-track {
  height: 8px;
  background: #999;
  border-radius: 4px;
}
.outerwrapper input[type=range]::-webkit-slider-thumb {
  border: 4px solid #fff;
  height: 25px;
  width: 25px;
  border-radius: 50%;
  background: #333;
  cursor: pointer;
  -webkit-appearance: none;
  margin-top: -7.6px;
  -webkit-transition: border-color 200ms;
          transition: border-color 200ms;
}
.outerwrapper input[type=range]:focus::-webkit-slider-thumb {
  border-color: skyblue;
}
.outerwrapper input[type=range]::-moz-range-track {
  height: 8px;
  background: #999;
  border-radius: 4px;
}
.outerwrapper input[type=range]::-moz-range-thumb {
  border: 4px solid #fff;
  height: 20px;
  width: 20px;
  border-radius: 50%;
  background: #333;
  cursor: pointer;
  transition: border-color 200ms;
}
.outerwrapper input[type=range]:focus::-moz-range-thumb {
  border-color: skyblue;
}
.outerwrapper input[type=range]::-ms-tooltip {
  display: none;
}
.outerwrapper .chart, .outerwrapper .widget-selector {
  position: relative;
}
.outerwrapper .chart .axis path, .outerwrapper .chart .axis line, .outerwrapper .widget-selector .axis path, .outerwrapper .widget-selector .axis line {
  fill: none;
  stroke: #666;
  shape-rendering: crispEdges;
}
.outerwrapper .chart text, .outerwrapper .widget-selector text {
  font-family: sans-serif;
  fill: #666;
  font-size: 13px;
  shape-rendering: crispEdges;
}
.outerwrapper .chart circle, .outerwrapper .widget-selector circle {
  -webkit-transition: opacity 0.2s ease;
  transition: opacity 0.2s ease;
}
.outerwrapper .chart .tick.major {
  stroke-dasharray: 2, 2;
}
.outerwrapper .chart .scatterGroup circle {
  cursor: pointer;
}
.outerwrapper .widget-tooltip {
  position: absolute;
  width: 200px;
  height: auto;
  padding: 6px 10px 6px 15px;
  color: #ccc;
  background-color: #333;
  pointer-events: none;
  border-radius: 5px;
  font-size: 0.8em;
  line-height: 1.4em;
  opacity: 1;
  -webkit-transition: opacity 0.2s ease;
  transition: opacity 0.2s ease;
}
.outerwrapper .widget-tooltip p {
  padding: 0;
}
.outerwrapper .widget-tooltip span {
  font-weight: bold;
  color: #fff;
}
.outerwrapper .hidden {
  opacity: 0;
  pointer-events: none;
}

</style>
<div class="outerwrapper" id="interd-graphic">
	<h2>Interdisciplinary headline</h2>

	<div class="chart">
		<div class="widget-tooltip hidden" id="widget-tooltip">
			<p id="name"></p>
			<p>References: <span id="ref">0</span></p>
			<p>Citations: <span id="cit">0</span></p>
		</div>
	</div>

	<div class="widget-selector">
		
		<div class="widget-scale"></div>
		<form class="widget-slider"></form>

	</div>

</div>

<!--[if gt IE 8]><!-->
<script type="text/javascript">
function buildData (data) {

	var disciplineArray = [];
	var yearArray = [];

	data.forEach(function (element, index, array) {
		element.ref = Math.round(parseFloat(element.OutDiscRef) * 100);
		element.cit = Math.round(parseFloat(element.OutDiscCit) * 100);

		if (disciplineArray.indexOf(element.Discipline) === -1) {
			disciplineArray.push(element.Discipline);
		}

		if (yearArray.indexOf(element.Year) === -1) {
			yearArray.push(element.Year);
		}
	});

	yearArray.forEach(function (element, index, array) {
		yearArray[index] = parseInt(element, 10);

	});

	yearArray.sort(function (a, b) {
		return a - b;
	});

	var nest = d3.nest()
		.key(function (d) {
			return d.Year;
		})
		.entries(data);

	return {
		data: nest,
		discipline: disciplineArray,
		years: yearArray
	};
}
function buildParams (argument) {
	var params = {};

	params.colour =  [
		"#e30513",  /* Arts */
		"#e84d0e",  /* Biology */
		"#f18700",  /* Biomedical Research */
		"#fbb900",  /* Chemistry */
		"#ffed00",  /* Clinical Medicine */
		"#d3d700",  /* Earth and Space */
		"#009640",  /* Engineering and Technology */
		"#79c6bf",  /* Health */
		"#009dd4",  /* Humanities */
		"#544595",  /* Mathematics */
		"#951b81",  /* Physics */
		"#b7195d",  /* Psychology */
		"#a99892" /* Social Sciences */

		// Need two more
	];

	params.uiColour = {
		veryLightGrey: "#ddd",
		lightGrey: "#999",
		grey: "#666",
		darkGrey: "#333"		
	};

	params.key = {
		xAxisLabel: "References to outside disciplines (%)",
		yAxisLabel: "Citations from outside disciplines (%)"
	};

	/*	Margin, Width and height */
	params.margin = {top: 20, right: 20, bottom: 50, left: 50};
	params.width = jQuery('.outerwrapper').width()  - params.margin.left - params.margin.right;
	params.height = jQuery('.outerwrapper').width() - params.margin.top - params.margin.bottom;

	params.sliderHeight = 60;

	params.year = 0;

	return params;
}
BuildWidget.prototype.buildAxes = function() {
	var self = this;

	this.yAxis = d3.svg.axis()
		.scale(this.yScale)
		.tickSize(-this.params.width ,0)
		.orient("left");

	this.xAxis = d3.svg.axis()
		.scale(this.xScale)
		.tickSize(-this.params.height ,0)
		.orient("bottom");

	this.yearAxis = d3.svg.axis()
		.scale(this.yearScale)
		.tickSize(20, 3)
		.orient("bottom")
		.tickFormat(d3.format("d"));

	this.svg.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate(" +this.params.margin.left + "," + this.params.margin.top + ")")
		.call(this.yAxis)
	  .append("g")
		.attr("class", "axisLabel")
	  .append("text")
		.attr("transform", "translate(" + -(this.params.margin.left * 0.6) + "," + (this.params.height / 2) + "), rotate(-90)")
		.style("text-anchor", "middle")
		.text(function () {
			return self.params.key.yAxisLabel;
		});

	this.svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + this.params.margin.left + "," + (this.params.margin.top + this.params.height) + ")")
		.call(this.xAxis)
	  .append("g")
		.attr("class","axisLabel")
	  .append("text")
		.attr("transform", "translate(" + (this.params.width / 2) + "," + (this.params.margin.bottom * 0.7) + ")")
		.style("text-anchor","middle")
		.text(function () {
				return self.params.key.xAxisLabel;
		});

	this.sliderSvg.append("g")
		.attr("class", "axis")
		.attr("transform","translate(" + this.params.margin.left + ",10)")
		.call(this.yearAxis);
};
BuildWidget.prototype.buildGraphic = function() {
	this.svg = d3.select(this.target + "> .chart").append("svg")
		.attr("width", this.params.width + this.params.margin.left + this.params.margin.right)
		.attr("height", this.params.height + this.params.margin.top + this.params.margin.bottom);

	var clip = this.svg.append("defs").append("svg:clipPath")
					.attr("id", "clip")
				  .append("svg:rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", this.params.width)
					.attr("height", this.params.height);

	this.scatterGroup = this.svg.append("g")
							.attr("class","scatterGroup")
							.attr("clip-path", "url(#clip)")
							.attr("transform","translate(" + this.params.margin.left + "," + this.params.margin.top + ")");	

	this.sliderSvg = d3.select(this.target + "> .widget-selector > .widget-scale")
		.append("svg")
		.attr("width", this.params.width + this.params.margin.left + this.params.margin.right)
		.attr("height", this.params.sliderHeight);
};
BuildWidget.prototype.buildInput = function() {
	var self = this;

	this.slider = d3.select(this.target + "> .widget-selector > .widget-slider")
		.style("padding", ("0 " + (this.params.margin.right - 10) + "px 0 " + (this.params.margin.left - 10) + "px"));

	this.slider.append("input")
				.attr("type","range")
				.attr("name","year")
				.attr("min", this.data.years[0])
				.attr("max", (this.data.years[this.data.years.length - 1]))
				.attr("step", 1)
				.attr("value", 0)
				.style("width", (this.params.width + 20) + "px")
				// .style("margin-top", this.params.sliderHeight + "px")
				.on("input", function() {
					self.params.year = (this.value - self.data.years[0]);
					self.updateScatterPlot();
				});

	/*	selection.on("input") doesn't seem to work in ie
		repeating the call to drawFrame() here on slide end */
	jQuery(".outerwrapper input[type='range']").click(function(){
		this.blur();
		this.focus();
		self.params.year = (this.value - self.data.years[0]);
		self.updateScatterPlot();
	});
	
};


	// <form oninput="result.value=parseInt(a.value)+parseInt(b.value)">
	// 	<input type="range" name="b" value="50" /> +
	// 	<input type="number" name="a" value="10" /> =
	// 	<output name="result"></output>
	// </form>

// var outerwrapper = d3.select(".outerwrapper");

/*	makeRange()
	Append an input[type="range"] and call drawFrame on change */
// function makeRange () {
// 	range = outerwrapper.select(".widget-selector")

// }

// makeRange();
BuildWidget.prototype.buildScales = function(first_argument) {

	this.yScale = d3.scale.linear()
		.range([this.params.height, 0])
		.domain([0,100]);

	this.xScale = d3.scale.linear()
		.range([0, this.params.width])
		.domain([0,100]);

	this.colourScale = d3.scale.ordinal()
		.range(this.params.colour)
		.domain(this.data.discipline);

	this.yearScale = d3.scale.linear()
		.range([0, this.params.width])
		.domain([d3.min(this.data.years),d3.max(this.data.years)]);

};
BuildWidget.prototype.enterScatterPlot = function() {
	var self = this;
	
	this.scatterGroup.selectAll("circle")
		.data(this.data.data[this.params.year].values, function (d) {
			return d.Specialty;
		})
		.enter()
	  .append("circle")
		.attr("cx", function (d) {
			return self.xScale(d.ref);
		})
		.attr("cy", function (d) {
			return self.yScale(d.cit);
		})
		.attr("r", 5)
		.attr("stroke", self.params.uiColour.darkGrey)
		.attr("stroke-width", 0)
		.attr("fill", function (d) {
			return self.colourScale(d.Specialty);
		});
};

BuildWidget.prototype.updateScatterPlot = function() {
	var self = this;

	this.scatterGroup.selectAll("circle")
		.data(this.data.data[this.params.year].values, function (d) {
			return d.Specialty;
		})
		.attr("cx", function (d) {
			return self.xScale(d.ref);
		})
		.attr("cy", function (d) {
			return self.yScale(d.cit);
		});
};
BuildWidget.prototype.buildTooltip = function() {
	var self = this;

	this.scatterGroup.selectAll("circle")
		.on("mouseover", function (d) {
			var myCircle = d3.select(this);

			myCircle.attr("stroke-width", 2);

			var tooltipWidth = parseInt(d3.select("#widget-tooltip").style("padding-left"),10) + parseInt(d3.select("#widget-tooltip").style("width"),10) + parseInt(d3.select("#widget-tooltip").style("padding-right"),10);

			var top = (parseFloat(myCircle.attr("cy")) + self.params.margin.top);
			var left = (parseFloat(myCircle.attr("cx")) + self.params.margin.left);

			if ( parseFloat(myCircle.attr("cx")) > (self.params.width / 2) ) {
				left -= tooltipWidth;
			}

			d3.select("#widget-tooltip")
				.style("top",  top + "px")
				.style("left", left + "px")
				.classed("hidden", false);

			d3.select("#name").text(d.Specialty);
			d3.select("#cit").text(d.cit + "%");
			d3.select("#ref").text(d.ref + "%");

		})
		.on("mouseout", function (d) {
			d3.select(this).attr("stroke-width", 0);
			self.hideTooltip();
		});
};

BuildWidget.prototype.hideTooltip = function () {
	d3.select("#widget-tooltip").classed("hidden", true);
};
function BuildWidget (target, params, data) {
	this.target = target;
	this.params = params;
	this.data = data;
}
(function() {
	var d3url = "http://www.nature.com/polopoly_static/js/d3.v3.min.js";
	var dataurl = "/data/interd-data.csv";

	var init = function($) {
		/*	Load D3 */
		$.getScript(d3url, function() {
			d3.csv(dataurl, function (error, d) {
				
				if (error) {
					// $(".status-message").css("display","block");
					console.log(error);
				} else {
				
					var data = buildData(d);

					var params = buildParams();

					var widget = new BuildWidget("#interd-graphic", params, data);

					widget.buildGraphic();
					widget.buildScales();
					widget.buildAxes();
					widget.enterScatterPlot();
					widget.buildInput();
					widget.buildTooltip();

					console.log(widget);

				}
			});

		});
	};

	setTimeout(function() {
		if (typeof jQuery !== 'undefined'){
			init(jQuery);
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);
})();
</script>
<!--<![endif]-->