<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
  display: none;
}

.js-disabled .status-message, .ie6 .status-message, .ie7 .status-message, .ie8 .status-message {
  display: block;
}

.outerwrapper {
  width: 100%;
  min-height: 900px;
  position: relative;
  border: 1px solid #c8c7cf;
  margin: 0 0 1.65em;
  display: none;
}
.outerwrapper h2, .outerwrapper h3, .outerwrapper p, .outerwrapper ul {
  padding: 10px 10px 0 10px;
  margin: 0;
}
.outerwrapper h3 {
  margin-left: 40px;
  padding-left: 0;
}
.outerwrapper ul {
  padding-left: 30px;
  padding-right: 10px;
}
.outerwrapper li {
  list-style: disc;
}
.outerwrapper .widget-footnote {
  margin-left: 40px;
  padding-bottom: 10px;
}
.outerwrapper .widget-footnote p {
  font-size: 80%;
  line-height: 1.4em;
  padding-left: 0;
}
.outerwrapper .chart, .outerwrapper .widget-slider {
  position: relative;
  margin-top: 10px;
}
.outerwrapper .chart .axis path, .outerwrapper .chart .axis line, .outerwrapper .widget-slider .axis path, .outerwrapper .widget-slider .axis line {
  fill: none;
  stroke: #666;
  shape-rendering: crispEdges;
}
.outerwrapper .chart text, .outerwrapper .widget-slider text {
  font-family: sans-serif;
  fill: #666;
  font-size: 13px;
  shape-rendering: crispEdges;
}
.outerwrapper .chart circle, .outerwrapper .widget-slider circle {
  -webkit-transition: opacity 0.2s ease;
  transition: opacity 0.2s ease;
}
.outerwrapper .chart .dot-selected, .outerwrapper .widget-slider .dot-selected {
  stroke-width: 3px;
}
.outerwrapper .hidden {
  opacity: 0;
  pointer-events: none;
}
.outerwrapper .chart .tick {
  stroke-dasharray: 2, 2;
}
.outerwrapper .chart .scatterGroup circle {
  cursor: pointer;
}
.outerwrapper .widget-slider .axis {
  pointer-events: none;
}
.outerwrapper .widget-slider .handle {
  cursor: pointer;
}
.outerwrapper .widget-tooltip {
  position: absolute;
  width: 200px;
  height: auto;
  padding: 6px 10px 6px 15px;
  color: #ccc;
  background-color: #333;
  pointer-events: none;
  border-radius: 5px;
  font-size: 0.8em;
  line-height: 1.4em;
  opacity: 1;
  -webkit-transition: opacity 0.2s ease;
  transition: opacity 0.2s ease;
}
.outerwrapper .widget-tooltip p {
  padding: 0;
}
.outerwrapper .widget-tooltip span {
  font-weight: bold;
  color: #fff;
}
.outerwrapper .hidden {
  opacity: 0;
  pointer-events: none;
}
.outerwrapper .widget-selector {
  padding-left: 40px;
  padding-right: 20px;
}
.outerwrapper .widget-selector select {
  width: 100%;
}
.outerwrapper .key {
  padding-left: 40px;
  padding-right: 20px;
}
.outerwrapper .key ul {
  margin-bottom: 0;
  padding-left: 0;
}
.outerwrapper .key ul li {
  display: inline-block;
  padding: 3px 10px 1px 0;
  margin: 5px 8px 5px 0;
  border-bottom-width: 5px;
  border-bottom-style: solid;
}
.outerwrapper .key ul li label {
  cursor: pointer;
}
.outerwrapper input[type="checkbox"] {
  cursor: pointer;
  margin-right: 5px;
}
.outerwrapper input[type="checkbox"]:checked:after {
  display: inline-block;
  opacity: 1;
}

</style>
<div class="status-message">
	<p>This interactive graphic requires a modern browser (e.g. Chrome, Safari or Firefox) with javascript enabled.</p>
	<p>The data used to build this graphic can be downloaded as comma-separated values in plain-text form here: <a href="http://www.nature.com/widget_assets_polopoly/v525n7569/interd-data.csv" title="Download interd-data.csv">interd-data.csv</a>.</p>
</div>

<div class="outerwrapper" id="interd-graphic">
	<h2>A measure of interdisciplinarity</h2>

	<p>In this chart, more interdisciplinary fields are in the top-right quadrant. From 1950-2014, a field’s position is determined by how much its papers cite outside disciplines (x-axis), and by how much outside disciplines subsequently cite its papers (y-axis). (Some years, certain fields have too few references to be plotted.)</p>

	<ul>
		<li>As a whole, interdisciplinarity declines until the mid 1970s, then rises.</li>
		<li>Over time, disciplines tend to cluster towards the diagonal. That’s partly a statistical artefact: emerging fields are small with few references from other fields, and then settle into position as they become larger and established.</li>
	</ul>

	<p>Hover over the dots to see specialities. <a href="http://www.nature.com/widget_assets_polopoly/v525n7569/interd-data.csv" title="Download interd-data.csv">Click here</a> to download the data used to build this graphic as comma-separated values.</p>

	<div class="chart">
		<div class="widget-tooltip hidden" id="widget-tooltip">
			<p id="name"></p>
			<p>References: <span id="ref">0</span></p>
			<p>Citations: <span id="cit">0</span></p>
		</div>
	</div>

	<h3>Choose a year:</h3>

	<div class="widget-slider"></div>

	<div class="widget-selector"></div>

	<h3>Choose a discipline</h3>
	
	<div class="key" id="key"></div>

	<div class="widget-footnote">
		<p>Papers from 1950-2014 were assigned to disciplines and specialities on the basis of their journals, using a classification system designed for the US National Science Foundation.</p>
		<p>Raw data from Thomson Reuters’ Web of Science, analysed by Cassidy Sugimoto (Indiana University), Juan Zhang (University of Quebec), Yves Gingras & Vincent Lariviere (University of Montreal). Data from personal communication, forming the basis of charts published in  V. Larivière & Y. Gingras in Beyond Bibliometrics (EDS B. Cronin & C. R. Sugimoto) 187–200 (MIT Press, 2014).</p>
	</div>

</div>

<!--[if gt IE 8]><!-->
<script type="text/javascript">
function buildData (data) {

	var disciplineArray = [];
	var discShort = [];
	var yearArray = [];

	data.forEach(function (element, index, array) {
		element.ref = Math.round(parseFloat(element.OutDiscRef) * 100);
		element.cit = Math.round(parseFloat(element.OutDiscCit) * 100);
		element.dis = element.Discipline.toLowerCase().split(' ').join("_");

		if ( isNaN(element.ref)) {
			element.ref = 0;
		}

		if ( isNaN(element.cit)) {
			element.cit = 0;
		}

		if (disciplineArray.indexOf(element.Discipline) === -1) {
			disciplineArray.push(element.Discipline);
		}

		if (discShort.indexOf(element.dis) === -1) {
			discShort.push(element.dis);
		}

		if (yearArray.indexOf(element.Year) === -1) {
			yearArray.push(element.Year);
		}
	});

	yearArray.forEach(function (element, index, array) {
		yearArray[index] = parseInt(element, 10);

	});

	yearArray.sort(function (a, b) {
		return a - b;
	});

	var nest = d3.nest()
		.key(function (d) {
			return d.Year;
		})
		.entries(data);

	nest.sort(function (a, b) {
		return parseInt(a.key, 10) - parseInt(b.key, 10);
	});

	return {
		data: nest,
		discipline: disciplineArray,
		disciplineShortName: discShort,
		years: yearArray,
		highlighted: [],
		year: 50
	};
}

function buildParams (argument) {
	var params = {};

	params.colour =  [
		"#e30513",  /* Arts */
		"#e84d0e",  /* Biology */
		"#f18700",  /* Biomedical Research */
		"#fbb900",  /* Chemistry */
		"#ffed00",  /* Clinical Medicine */
		"#d3d700",  /* Earth and Space */
		"#009640",  /* Engineering and Technology */
		"#79c6bf",  /* Health */
		"#009dd4",  /* Humanities */
		"#544595",  /* Mathematics */
		"#951b81",  /* Physics */
		"#b7195d",  /* Psychology */
		"#a99892" /* Social Sciences */
	];

	params.uiColour = {
		veryLightGrey: "#ddd",
		lightGrey: "#999",
		grey: "#666",
		darkGrey: "#333"		
	};

	params.key = {
		xAxisLabel: "References to outside disciplines (%)",
		yAxisLabel: "Citations from outside disciplines (%)"
	};

	/*	Margin, Width and height */
	params.margin = {top: 20, right: 20, bottom: 50, left: 50};
	params.width = jQuery('.outerwrapper').width()  - params.margin.left - params.margin.right;
	params.height = jQuery('.outerwrapper').width() - params.margin.top - params.margin.bottom;

	params.dotRadius = params.width > 350 ?  5 : 3;

	params.yearPixelsPerTick = 40;
		
	params.sliderHeight = 50;

	return params;
}


BuildWidget.prototype.buildAxes = function() {
	var self = this;

	this.yAxis = d3.svg.axis()
		.scale(this.yScale)
		.tickSize(-this.params.width ,0)
		.orient("left");

	this.xAxis = d3.svg.axis()
		.scale(this.xScale)
		.tickSize(-this.params.height ,0)
		.orient("bottom");

	this.yearAxis = d3.svg.axis()
		.scale(this.yearScale)
		.tickSize(20, 0)
		.ticks(this.params.width / this.params.yearPixelsPerTick)
		.orient("bottom")
		.tickFormat(d3.format("d"));

	this.yAxisGroup.call(this.yAxis)
	  .append("g")
		.attr("class", "axisLabel")
	  .append("text")
		.attr("transform", "translate(" + -(this.params.margin.left * 0.6) + "," + (this.params.height / 2) + "), rotate(-90)")
		.style("text-anchor", "middle")
		.text(function () {
			return self.params.key.yAxisLabel;
		});

	this.xAxisGroup.call(this.xAxis)
	  .append("g")
		.attr("class","axisLabel")
	  .append("text")
		.attr("transform", "translate(" + (this.params.width / 2) + "," + (this.params.margin.bottom * 0.7) + ")")
		.style("text-anchor","middle")
		.text(function () {
				return self.params.key.xAxisLabel;
		});

	this.xAxisGroup.append("line")
		.attr("class", "quadrant-line")
		.attr("x1", (this.params.width / 2))
		.attr("y1", 0)
		.attr("x2", (this.params.width / 2))
		.attr("y2", -this.params.height);

	if (this.params.width > 350) {
		this.xAxisGroup.append("text")
			.style("text-anchor","start")
			.attr("dx", 15)
			.attr("dy", -15)
			.style("font-size", "20px")
			.style("fill", this.params.uiColour.lightGrey)
			.text("Less interdisciplinary");

		this.xAxisGroup.append("text")
			.attr("transform", "translate(" + this.params.width + "," + (this.params.height * -1) + ")")
			.style("text-anchor","end")
			.attr("dx", -15)
			.attr("dy", 30)
			.style("font-size", "20px")
			.style("fill", this.params.uiColour.lightGrey)
			.text("More interdisciplinary");		
	}

	this.yAxisGroup.append("line")
		.attr("class", "quadrant-line")
		.attr("x1", 0)
		.attr("y1", (this.params.height / 2))
		.attr("x2", this.params.width)
		.attr("y2", (this.params.height / 2));
};

BuildWidget.prototype.buildGraphic = function() {
	this.svg = d3.select(this.target + "> .chart").append("svg")
		.attr("width", this.params.width + this.params.margin.left + this.params.margin.right)
		.attr("height", this.params.height + this.params.margin.top + this.params.margin.bottom);

	var clip = this.svg.append("defs").append("svg:clipPath")
					.attr("id", "clip")
				  .append("svg:rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", this.params.width)
					.attr("height", this.params.height);

	this.yAxisGroup = this.svg.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate(" +this.params.margin.left + "," + this.params.margin.top + ")");

	this.xAxisGroup = this.svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + this.params.margin.left + "," + (this.params.margin.top + this.params.height) + ")");

	this.trailsGroup = this.svg.append("g")
							.attr("class","trailsGroup")
							.attr("clip-path", "url(#clip)")
							.attr("transform","translate(" + this.params.margin.left + "," + this.params.margin.top + ")");	

	this.scatterGroup = this.svg.append("g")
							.attr("class","scatterGroup")
							.attr("clip-path", "url(#clip)")
							.attr("transform","translate(" + this.params.margin.left + "," + this.params.margin.top + ")");	

	this.sliderSvg = d3.select(this.target + "> .widget-slider ")
		.append("svg")
		.attr("width", this.params.width + this.params.margin.left + this.params.margin.right)
		.attr("height", this.params.sliderHeight);

	this.dropdown = d3.select(this.target + "> .widget-selector")
		.append("select");
};

BuildWidget.prototype.buildInput = function() {
	var self = this;
	var yearNum;

	var brush = d3.svg.brush()
		.x(this.yearScale)
		.extent([0,0])
		.on("brush", brushed);

	this.sliderSvg.append("g")
		.attr("class", "axis")
		.attr("transform","translate(" + this.params.margin.left + ",10)")
	  .call(this.yearAxis)
		.select(".domain")
		.attr("stroke-width", "10")
		.attr("stroke-linecap", "round")
		.style("shape-rendering","auto")
		.style("stroke", this.params.uiColour.lightGrey);

	var slider = this.sliderSvg.append("g")
		.attr("class","slider")
		.attr("transform","translate(" + this.params.margin.left + ",0)")
		.call(brush);

	slider.selectAll(".extent, .resize")
		.remove();

	slider.select(".background")
		.attr("height", this.params.sliderHeight)
		.style("cursor", "auto");

	var handle = slider.append("circle")
		.attr("class", "handle")
		.attr("transform", "translate(0," + 10 + ")" )
		.attr("cx", self.yearScale(self.data.years[self.data.year]))
		.attr("r", 10);

	this.dropdown.selectAll("option")
		.data(this.data.years)
		.enter()
	  .append("option")
		.attr("value", function (d) { return d; })
		.text(function (d) { return d; });
	
	this.dropdown.node().value = this.data.years[this.data.year];

	this.dropdown.on("change", function () {
			yearNum = parseInt(this.value, 10);
			brush.extent([yearNum, yearNum]);
			brushed();
		});

	function brushed() {
		var value = brush.extent()[0];

		if (d3.event.sourceEvent) { /* not a programmatic event */
			value = self.yearScale.invert(d3.mouse(this)[0]);
			brush.extent([value, value]);
		}

		self.data.year = self.data.years.indexOf(Math.round(value));
		self.updateView();
		self.yearLabel.text(self.data.years[self.data.year]);

		handle.attr("cx", self.yearScale(value));
		self.dropdown.node().value = Math.round(value);
	}
};

BuildWidget.prototype.buildColourList = function (target) {
	var self = this;
	var thisProp;

	function makeSafe (i) {
		return i.toLowerCase().split(' ').join("_");
	}

	var extendedDiscipline = ["All"];
	for (var i = 0; i < this.data.discipline.length; i++) {
		extendedDiscipline.push(this.data.discipline[i]);
	}

	this.checkboxList = d3.select(target)
	  .append("ul");

	this.checkboxes = this.checkboxList
		.selectAll("li")
		.data(extendedDiscipline)
		.enter()
	  .append("li")
		.style("border-bottom-color", function (d) {
			if (d === "All") {
				return self.params.uiColour.lightGrey;
			} else {
				return self.colourScale(d);
			}
		});
	
	this.checkboxes.append("input")
		.attr("type","checkbox")
		.attr("checked","true")
		.attr("value", function (d) {
			return makeSafe(d);
		})
		.attr("name", function (d) {
			return makeSafe(d);
		})
		.attr("id", function (d) {
			return makeSafe(d);
		});

	this.checkboxes.append("label")
		.text(function (d) { return d;})
		.attr("for", function (d) {
			return makeSafe(d);
		});

	this.checkboxes.on("change", function () {
		var checkbox = d3.select(this).select("input");

		if (checkbox.attr("value") === "all") {
			console.log();
			thisProp = checkbox.node().checked;

			self.checkboxes.each(function () {
				d3.select(this).select("input").node().checked = thisProp;
			});
		}

		self.updateView();

	});
};

BuildWidget.prototype.buildScales = function(first_argument) {
	var self = this;

	this.yScale = d3.scale.linear()
		.range([this.params.height, 0])
		.domain([0,100]);

	this.xScale = d3.scale.linear()
		.range([0, this.params.width])
		.domain([0,100]);

	this.colourScale = d3.scale.ordinal()
		.range(this.params.colour)
		.domain(this.data.discipline);

	this.yearScale = d3.scale.linear()
		.range([0, this.params.width])
		.domain([d3.min(this.data.years),d3.max(this.data.years)])
		.clamp(true);

	this.line = d3.svg.line()
	    .x(function(d){
	    	return self.xScale(d.ref);
	    })
	    .y(function(d){
	    	return self.yScale(d.cit);
	    });
};

BuildWidget.prototype.enterScatterPlot = function() {
	var self = this;
	
	this.scatterGroup.selectAll("circle")
		.data(this.data.data[this.data.year].values, function (d) {
			return d.Specialty;
		})
		.enter()
	  .append("circle")
		.attr("cx", function (d) {
			return self.xScale(d.ref);
		})
		.attr("cy", function (d) {
			return self.yScale(d.cit);
		})
		.attr("r", self.params.dotRadius)
		.attr("stroke", self.params.uiColour.darkGrey)
		.attr("stroke-width", 0)
		.attr("fill", function (d) {
			return self.colourScale(d.Discipline);
		})
		.classed("hidden", function (d) {
			if (self.data.disciplineShortName.indexOf(d.dis) === -1) {
				return true;
			} else {
				return false;
			}
		})
		.classed("dot-selected", function (d) {
			if (self.data.highlighted.indexOf(d.Specialty) === -1) {
				return false;
			} else {
				return true;
			}
		});
};

BuildWidget.prototype.updateScatterPlot = function() {
	var self = this;

	this.scatterGroup.selectAll("circle")
		.data(this.data.data[this.data.year].values, function (d) {
			return d.Specialty;
		})
		.attr("cx", function (d) {
			return self.xScale(d.ref);
		})
		.attr("cy", function (d) {
			return self.yScale(d.cit);
		})
		.classed("hidden", function (d) {
			if (self.data.disciplineShortName.indexOf(d.dis) === -1) {
				return true;
			} else {
				return false;
			}
		})
		.classed("dot-selected", function (d) {
			if (self.data.highlighted.indexOf(d.Specialty) === -1) {
				return false;
			} else {
				return true;
			}
		});
};

BuildWidget.prototype.exitScatterPlot = function () {
	this.scatterGroup.selectAll("circle")
		.data(this.data.data[this.data.year].values, function (d) {
			return d.Specialty;
		})
		.exit()
		.classed("hidden", true)
		.remove();
};

BuildWidget.prototype.buildShowHighlight = function() {
	var self = this;

	this.scatterGroup.selectAll("circle")
		.on("click", function (d) {
			var index = self.data.highlighted.indexOf(d.Specialty);

			if (index === -1 ) {
				self.data.highlighted.push(d.Specialty);
			} else {
				self.data.highlighted.splice(index, 1);
			}

			console.log(self.data.highlighted);

			self.updateView();
		});
};

BuildWidget.prototype.buildTooltip = function() {
	var self = this;

	this.scatterGroup.selectAll("circle")
		.on("mouseover", function (d) {
			var myCircle = d3.select(this);

			var tooltipWidth = parseInt(d3.select("#widget-tooltip").style("padding-left"),10) + parseInt(d3.select("#widget-tooltip").style("width"),10) + parseInt(d3.select("#widget-tooltip").style("padding-right"),10);

			var top = (parseFloat(myCircle.attr("cy")) + self.params.margin.top);
			var left = (parseFloat(myCircle.attr("cx")) + self.params.margin.left);

			if ( parseFloat(myCircle.attr("cx")) > (self.params.width / 2) ) {
				left -= tooltipWidth;
			}

			d3.select("#widget-tooltip")
				.style("top",  top + "px")
				.style("left", left + "px")
				.classed("hidden", false);

			d3.select("#name").text(d.Specialty);
			d3.select("#cit").text(d.cit + "%");
			d3.select("#ref").text(d.ref + "%");

		})
		.on("mouseout", function (d) {
			self.hideTooltip();
		});
};

BuildWidget.prototype.hideTooltip = function () {
	this.scatterGroup.selectAll("circle").attr("stroke-width", 0);
	d3.select("#widget-tooltip").classed("hidden", true);
};

BuildWidget.prototype.buildYearLabel = function() {
	this.yearLabel = this.svg.append("text")
		.attr("transform", "translate(" + this.params.margin.left + "," + this.params.margin.top + ")")
		.style("text-anchor","start")
		.attr("dx", 15)
		.attr("dy", 40)
		.style("font-size", "30px")
		.style("fill", this.params.uiColour.darkGrey)
		.text(this.data.years[this.data.year]);
};

function BuildWidget (target, params, data) {
	this.target = target;
	this.params = params;
	this.data = data;
}

BuildWidget.prototype.build = function() {
	this.buildGraphic();
	this.buildScales();
	this.buildAxes();
	this.enterScatterPlot();

	this.buildInput();
	this.buildTooltip();

	this.buildShowHighlight();

	this.buildColourList("#key");
	this.buildYearLabel();

};

BuildWidget.prototype.destroy = function() {
	this.svg.remove();
	this.sliderSvg.remove();
	this.dropdown.remove();
	this.checkboxList.remove();

	while (this.data.showTrail.length > 0) {
		this.data.showTrail.pop();
	}
};

BuildWidget.prototype.updateView = function() {
	var selectedDisciplines = []; 

	var checkboxes = jQuery(".outerwrapper #key input:checked");

	while (this.data.disciplineShortName.length > 0) {
		this.data.disciplineShortName.shift();
	}

	for (var i = 0; i < checkboxes.length; i++) {
		this.data.disciplineShortName.push(checkboxes.eq(i).val());
	}

	this.enterScatterPlot();
	this.updateScatterPlot();
	this.exitScatterPlot();

	this.hideTooltip();
	this.buildTooltip();

	this.buildShowHighlight();
};

(function() {
	var d3url = "http://www.nature.com/widget_assets_polopoly/v518n7538/d3.v3.min.js";
	// var dataurl = "http://www.nature.com/widget_assets_polopoly/v525n7569/interd-data.csv";
	var dataurl = "data/interd-data.csv";

	var init = function($) {
		/*	Load D3 */
		$.getScript(d3url, function() {
			d3.csv(dataurl, function (error, d) {

				var data, params, widget;
				var width = $(window).width();
				var didResize = false;
				
				if (error) {
					$(".status-message").css("display","block");
				} else {
					$(".outerwrapper").css("display","block");

					data = buildData(d);
					params = buildParams();
					widget = new BuildWidget("#interd-graphic", params, data);

					widget.build();
				}

				$( window ).resize(function() {
					if($(window).width() != width){ 
						width = $(window).width();
						didResize = true;

						/* Throttle the resize */
						setTimeout(function () {
							if (didResize) {
								widget.destroy();
								widget.params = buildParams();
								widget.build();
								widget.updateView();
								
								didResize = false;
							}
						}, 60);

					}
				});
			});

		});
	};

	setTimeout(function() {
		if (typeof jQuery !== 'undefined'){
			init(jQuery);
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);
})();

</script>
<!--<![endif]-->