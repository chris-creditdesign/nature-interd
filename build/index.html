<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Polopoly</title>
	<script src="http://nature.com/view/scripts/jquery/jquery-1.7.2.min.js" type="text/javascript"></script>
	<!-- <script src="https://poly-admin1.nature.com/polopoly_static/js/jquery-1.6.4.js" type="text/javascript"></script> -->

	<link rel="stylesheet" type="text/css" href="polopoly/reset.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/html5.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/layout.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/header.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/footer.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/news-main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/comments.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/mobile.css" />	
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=2.2,user-scalable=yes"/>


</head>


<!--[if lt IE 6]><body class="lt-ie6"><![endif]-->
<!--[if IE 6]><body class="ie6"><![endif]-->
<!--[if IE 7]><body class="ie7"><![endif]-->
<!--[if IE 8]><body class="ie8"><![endif]-->
<!--[if gt IE 8]><body class="gt-ie8"><![endif]-->
<!--[if !IE]>--><body><!--<![endif]-->

<div id="constrain">

<div id="main">
	<div id="constrain-content" class="cleared">
		<div id="content" class="col">
			<article>
				<div id="article">
					<section>
						<div class="section">
							<div class="html-widget img-rigth">

<!-- ========= PASTED POLOPOLY HEADER ABOVE ========= -->







<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
  display: none;
}

.js-disabled .status-message, .ie6 .status-message, .ie7 .status-message, .ie8 .status-message {
  display: block;
}

.outerwrapper {
  width: 100%;
  min-height: 900px;
  position: relative;
  border: 1px solid #c8c7cf;
  display: none;
}
.outerwrapper h2, .outerwrapper h3, .outerwrapper p {
  padding: 10px 10px 0 10px;
  margin: 0;
}
.outerwrapper .chart, .outerwrapper .widget-selector {
  position: relative;
}
.outerwrapper .chart .axis path, .outerwrapper .chart .axis line, .outerwrapper .widget-selector .axis path, .outerwrapper .widget-selector .axis line {
  fill: none;
  stroke: #666;
  shape-rendering: crispEdges;
}
.outerwrapper .chart text, .outerwrapper .widget-selector text {
  font-family: sans-serif;
  fill: #666;
  font-size: 13px;
  shape-rendering: crispEdges;
}
.outerwrapper .chart circle, .outerwrapper .widget-selector circle {
  -webkit-transition: opacity 0.2s ease;
  transition: opacity 0.2s ease;
}
.outerwrapper .hidden {
  opacity: 0;
  pointer-events: none;
}
.outerwrapper .chart .tick.major {
  stroke-dasharray: 2, 2;
}
.outerwrapper .chart .scatterGroup circle {
  cursor: pointer;
}
.outerwrapper .widget-tooltip {
  position: absolute;
  width: 200px;
  height: auto;
  padding: 6px 10px 6px 15px;
  color: #ccc;
  background-color: #333;
  pointer-events: none;
  border-radius: 5px;
  font-size: 0.8em;
  line-height: 1.4em;
  opacity: 1;
  -webkit-transition: opacity 0.2s ease;
  transition: opacity 0.2s ease;
}
.outerwrapper .widget-tooltip p {
  padding: 0;
}
.outerwrapper .widget-tooltip span {
  font-weight: bold;
  color: #fff;
}
.outerwrapper .hidden {
  opacity: 0;
  pointer-events: none;
}
.outerwrapper .key ul li {
  display: inline-block;
  padding: 3px 10px 1px 0;
  margin: 5px;
  border-bottom-width: 5px;
  border-bottom-style: solid;
}
.outerwrapper .key ul li label {
  cursor: pointer;
}
.outerwrapper input[type="checkbox"] {
  cursor: pointer;
  margin-right: 5px;
}
.outerwrapper input[type="checkbox"]:checked:after {
  display: inline-block;
  opacity: 1;
}

</style>
<div class="status-message">
	<p>This interactive graphic requires a modern browser (e.g. Chrome, Safari or Firefox) with javascript enabled.</p>
	<p>The data used to build this graphic can be downloaded as comma-separated values in plain-text form here: <a href="#" title="Download xxx  XXK">xxxx.txt</a>.</p>
</div>


<div class="outerwrapper" id="interd-graphic">
	<h2>Interdisciplinary headline</h2>

	<div class="chart">
		<div class="widget-tooltip hidden" id="widget-tooltip">
			<p id="name"></p>
			<p>References: <span id="ref">0</span></p>
			<p>Citations: <span id="cit">0</span></p>
		</div>
	</div>

	<div class="widget-selector">
		
		<div class="widget-slider"></div>

	</div>

	<div class="key" id="key"></div>

</div>

<!--[if gt IE 8]><!-->
<script type="text/javascript">
function buildData (data) {

	var disciplineArray = [];
	var discShort = [];
	var yearArray = [];

	data.forEach(function (element, index, array) {
		element.ref = Math.round(parseFloat(element.OutDiscRef) * 100);
		element.cit = Math.round(parseFloat(element.OutDiscCit) * 100);
		element.dis = element.Discipline.toLowerCase().split(' ').join("_");

		if ( isNaN(element.ref)) {
			element.ref = 0;
		}

		if ( isNaN(element.cit)) {
			element.cit = 0;
		}

		if (disciplineArray.indexOf(element.Discipline) === -1) {
			disciplineArray.push(element.Discipline);
		}

		if (discShort.indexOf(element.dis) === -1) {
			discShort.push(element.dis);
		}

		if (yearArray.indexOf(element.Year) === -1) {
			yearArray.push(element.Year);
		}
	});

	yearArray.forEach(function (element, index, array) {
		yearArray[index] = parseInt(element, 10);

	});

	yearArray.sort(function (a, b) {
		return a - b;
	});

	var nest = d3.nest()
		.key(function (d) {
			return d.Year;
		})
		.entries(data);

	nest.sort(function (a, b) {
		return parseInt(a.key, 10) - parseInt(b.key, 10);
	});

	return {
		data: nest,
		discipline: disciplineArray,
		disciplineShortName: discShort,
		years: yearArray
	};
}
function buildParams (argument) {
	var params = {};

	params.colour =  [
		"#e30513",  /* Arts */
		"#e84d0e",  /* Biology */
		"#f18700",  /* Biomedical Research */
		"#fbb900",  /* Chemistry */
		"#ffed00",  /* Clinical Medicine */
		"#d3d700",  /* Earth and Space */
		"#009640",  /* Engineering and Technology */
		"#79c6bf",  /* Health */
		"#009dd4",  /* Humanities */
		"#544595",  /* Mathematics */
		"#951b81",  /* Physics */
		"#b7195d",  /* Psychology */
		"#a99892" /* Social Sciences */

		// Need two more
	];

	params.uiColour = {
		veryLightGrey: "#ddd",
		lightGrey: "#999",
		grey: "#666",
		darkGrey: "#333"		
	};

	params.key = {
		xAxisLabel: "References to outside disciplines (%)",
		yAxisLabel: "Citations from outside disciplines (%)"
	};

	/*	Margin, Width and height */
	params.margin = {top: 20, right: 20, bottom: 50, left: 50};
	params.width = jQuery('.outerwrapper').width()  - params.margin.left - params.margin.right;
	params.height = jQuery('.outerwrapper').width() - params.margin.top - params.margin.bottom;

	params.sliderHeight = 60;

	params.year = 0;

	return params;
}
BuildWidget.prototype.buildAxes = function() {
	var self = this;

	this.yAxis = d3.svg.axis()
		.scale(this.yScale)
		.tickSize(-this.params.width ,0)
		.orient("left");

	this.xAxis = d3.svg.axis()
		.scale(this.xScale)
		.tickSize(-this.params.height ,0)
		.orient("bottom");

	this.yearAxis = d3.svg.axis()
		.scale(this.yearScale)
		.tickSize(20, 0)
		.orient("bottom")
		.tickFormat(d3.format("d"));

	this.svg.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate(" +this.params.margin.left + "," + this.params.margin.top + ")")
		.call(this.yAxis)
	  .append("g")
		.attr("class", "axisLabel")
	  .append("text")
		.attr("transform", "translate(" + -(this.params.margin.left * 0.6) + "," + (this.params.height / 2) + "), rotate(-90)")
		.style("text-anchor", "middle")
		.text(function () {
			return self.params.key.yAxisLabel;
		});

	this.svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + this.params.margin.left + "," + (this.params.margin.top + this.params.height) + ")")
		.call(this.xAxis)
	  .append("g")
		.attr("class","axisLabel")
	  .append("text")
		.attr("transform", "translate(" + (this.params.width / 2) + "," + (this.params.margin.bottom * 0.7) + ")")
		.style("text-anchor","middle")
		.text(function () {
				return self.params.key.xAxisLabel;
		});

};
BuildWidget.prototype.buildGraphic = function() {
	this.svg = d3.select(this.target + "> .chart").append("svg")
		.attr("width", this.params.width + this.params.margin.left + this.params.margin.right)
		.attr("height", this.params.height + this.params.margin.top + this.params.margin.bottom);

	var clip = this.svg.append("defs").append("svg:clipPath")
					.attr("id", "clip")
				  .append("svg:rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", this.params.width)
					.attr("height", this.params.height);

	this.scatterGroup = this.svg.append("g")
							.attr("class","scatterGroup")
							.attr("clip-path", "url(#clip)")
							.attr("transform","translate(" + this.params.margin.left + "," + this.params.margin.top + ")");	

	this.sliderSvg = d3.select(this.target + "> .widget-selector ")
		.append("svg")
		.attr("width", this.params.width + this.params.margin.left + this.params.margin.right)
		.attr("height", this.params.sliderHeight);
};
BuildWidget.prototype.buildInput = function() {
	var self = this;

	var brush = d3.svg.brush()
		.x(this.yearScale)
		.extent([0,0])
		.on("brush", brushed);

	this.sliderSvg.append("g")
		.attr("class", "axis")
		.attr("transform","translate(" + this.params.margin.left + ",10)")
	  .call(this.yearAxis)
		.select(".domain")
		.attr("stroke-width", "10")
		.attr("stroke-linecap", "round")
		.style("shape-rendering","auto")
		.style("stroke", this.params.uiColour.lightGrey);

	var slider = this.sliderSvg.append("g")
		.attr("class","slider")
		.attr("transform","translate(" + this.params.margin.left + ",0)")
		.call(brush);

	slider.selectAll(".extent, .resize")
		.remove();

	slider.select(".background")
		.attr("height", this.params.sliderHeight);

	var handle = slider.append("circle")
		.attr("class", "handle")
		.attr("transform", "translate(0, " + 10 + ")" )
		.attr("r", 10);

	function brushed() {
		var value = brush.extent()[0];

		if (d3.event.sourceEvent) { /* not a programmatic event */
			value = self.yearScale.invert(d3.mouse(this)[0]);
			brush.extent([value, value]);
		}

		self.params.year = self.data.years.indexOf(Math.round(value));
		self.updateView();
		self.yearLabel.text(self.data.years[self.params.year]);


		handle.attr("cx", self.yearScale(value));
	}
};



BuildWidget.prototype.buildColourList = function (target) {
	var self = this;
	var thisProp;

	function makeSafe (i) {
		return i.toLowerCase().split(' ').join("_");
	}

	var extendedDiscipline = ["All"];
	for (var i = 0; i < this.data.discipline.length; i++) {
		extendedDiscipline.push(this.data.discipline[i]);
	}

	this.checkboxList = d3.select(target)
	  .append("ul");

	this.checkboxes = this.checkboxList
		.selectAll("li")
		.data(extendedDiscipline)
		.enter()
	  .append("li")
		.style("border-bottom-color", function (d) {
			if (d === "All") {
				return self.params.uiColour.lightGrey;
			} else {
				return self.colourScale(d);
			}
		});
	
	this.checkboxes.append("input")
		.attr("type","checkbox")
		.attr("checked","true")
		.attr("value", function (d) {
			return makeSafe(d);
		})
		.attr("name", function (d) {
			return makeSafe(d);
		})
		.attr("id", function (d) {
			return makeSafe(d);
		});

	this.checkboxes.append("label")
		.text(function (d) { return d;})
		.attr("for", function (d) {
			return makeSafe(d);
		});


	this.checkboxes.on("change", function () {
		var checkbox = d3.select(this).select("input");

		if (checkbox.attr("value") === "all") {
			console.log();
			thisProp = checkbox.node().checked;


		
			self.checkboxes.each(function () {
				// this.checked = thisProp;
				d3.select(this).select("input").node().checked = thisProp;
			});
		}

		self.updateView();

	});
};
BuildWidget.prototype.buildScales = function(first_argument) {

	this.yScale = d3.scale.linear()
		.range([this.params.height, 0])
		.domain([0,100]);

	this.xScale = d3.scale.linear()
		.range([0, this.params.width])
		.domain([0,100]);

	this.colourScale = d3.scale.ordinal()
		.range(this.params.colour)
		.domain(this.data.discipline);

	this.yearScale = d3.scale.linear()
		.range([0, this.params.width])
		.domain([d3.min(this.data.years),d3.max(this.data.years)])
		.clamp(true);

};
BuildWidget.prototype.enterScatterPlot = function() {
	var self = this;
	
	this.scatterGroup.selectAll("circle")
		.data(this.data.data[this.params.year].values, function (d) {
			return d.Specialty;
		})
		.enter()
	  .append("circle")
		.attr("cx", function (d) {
			return self.xScale(d.ref);
		})
		.attr("cy", function (d) {
			return self.yScale(d.cit);
		})
		.attr("r", 5)
		.attr("stroke", self.params.uiColour.darkGrey)
		.attr("stroke-width", 0)
		.attr("fill", function (d) {
			return self.colourScale(d.Discipline);
		})
		.classed("hidden", function (d) {
			if (self.data.disciplineShortName.indexOf(d.dis) === -1) {
				return true;
			} else {
				return false;
			}
		});


};

BuildWidget.prototype.updateScatterPlot = function() {
	var self = this;

	this.scatterGroup.selectAll("circle")
		.data(this.data.data[this.params.year].values, function (d) {
			return d.Specialty;
		})
		.attr("cx", function (d) {
			return self.xScale(d.ref);
		})
		.attr("cy", function (d) {
			return self.yScale(d.cit);
		})
		.classed("hidden", function (d) {
			if (self.data.disciplineShortName.indexOf(d.dis) === -1) {
				return true;
			} else {
				return false;
			}
		});
};

BuildWidget.prototype.exitScatterPlot = function () {
	this.scatterGroup.selectAll("circle")
		.data(this.data.data[this.params.year].values, function (d) {
			return d.Specialty;
		})
		.exit()
		.classed("hidden", true)
		.remove();
};

BuildWidget.prototype.buildTooltip = function() {
	var self = this;

	this.scatterGroup.selectAll("circle")
		.on("mouseover", function (d) {
			var myCircle = d3.select(this);

			myCircle.attr("stroke-width", 2);

			var tooltipWidth = parseInt(d3.select("#widget-tooltip").style("padding-left"),10) + parseInt(d3.select("#widget-tooltip").style("width"),10) + parseInt(d3.select("#widget-tooltip").style("padding-right"),10);

			var top = (parseFloat(myCircle.attr("cy")) + self.params.margin.top);
			var left = (parseFloat(myCircle.attr("cx")) + self.params.margin.left);

			if ( parseFloat(myCircle.attr("cx")) > (self.params.width / 2) ) {
				left -= tooltipWidth;
			}

			d3.select("#widget-tooltip")
				.style("top",  top + "px")
				.style("left", left + "px")
				.classed("hidden", false);

			d3.select("#name").text(d.Specialty);
			d3.select("#cit").text(d.cit + "%");
			d3.select("#ref").text(d.ref + "%");

		})
		.on("mouseout", function (d) {
			d3.select(this).attr("stroke-width", 0);
			self.hideTooltip();
		});
};

BuildWidget.prototype.hideTooltip = function () {
	d3.select("#widget-tooltip").classed("hidden", true);
};

BuildWidget.prototype.buildYearLabel = function() {
	this.yearLabel = this.svg.append("text")
		.attr("transform", "translate(" + this.params.margin.left + "," + this.params.margin.top + ")")
		.style("text-anchor","start")
		.attr("dx", 15)
		.attr("dy", 40)
		.style("font-size", "30px")
		.style("fill", this.params.uiColour.darkGrey)
		.text(this.data.years[this.params.year]);
};
function BuildWidget (target, params, data) {
	this.target = target;
	this.params = params;
	this.data = data;
}

BuildWidget.prototype.build = function() {
	this.buildGraphic();
	this.buildScales();
	this.buildAxes();
	this.enterScatterPlot();
	this.buildInput();
	this.buildTooltip();

	this.buildColourList("#key");
	this.buildYearLabel();

};

BuildWidget.prototype.destroy = function() {
	this.svg.remove();
	this.sliderSvg.remove();
	this.checkboxList.remove();
};

BuildWidget.prototype.updateView = function() {
	var selectedDisciplines = []; 

	var checkboxes = jQuery(".outerwrapper #key input:checked");

	while (this.data.disciplineShortName.length > 0) {
		this.data.disciplineShortName.shift();
	}

	for (var i = 0; i < checkboxes.length; i++) {
		this.data.disciplineShortName.push(checkboxes.eq(i).val());
	}

	this.enterScatterPlot();
	this.updateScatterPlot();
	this.exitScatterPlot();
	this.buildTooltip();

};
(function() {
	var d3url = "http://www.nature.com/polopoly_static/js/d3.v3.min.js";
	var dataurl = "data/interd-data.csv";

	var init = function($) {
		/*	Load D3 */
		$.getScript(d3url, function() {
			d3.csv(dataurl, function (error, d) {

				var data, params, widget;
				var width = $(window).width();
				var didResize = false;
				
				if (error) {
					$(".status-message").css("display","block");
				} else {
					$(".outerwrapper").css("display","block");

					data = buildData(d);
					params = buildParams();
					widget = new BuildWidget("#interd-graphic", params, data);
					widget.build();
				}

				$( window ).on("resize", function() {
					if($(window).width() != width){ 
						width = $(window).width();
						didResize = true;

						/* Throttle the resize */
						setTimeout(function () {
							if (didResize) {
								widget.destroy();
								widget.params = buildParams();
								widget.build();
								widget.updateView();
								
								didResize = false;
							}
						}, 60);

					}
				});



			});

		});
	};

	setTimeout(function() {
		if (typeof jQuery !== 'undefined'){
			init(jQuery);
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);
})();
</script>
<!--<![endif]-->
<!-- ========= PASTED POLOPOLY FOOTER BELOW ========= -->

</div>							
						</div>
					</section>
				</div>
			</article>
		</div>
	</div>
</div>
</div>
</body>
</html>